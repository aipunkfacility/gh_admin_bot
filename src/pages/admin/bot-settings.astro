---
import AdminLayout from '../../layouts/AdminLayout.astro';
import { getCollection } from '../../lib/data-store';

export const prerender = false;

const cookies = Astro.cookies;
const ADMIN_PASSWORD = import.meta.env.ADMIN_PASSWORD;

let isAuth = false;
if (ADMIN_PASSWORD) {
    const { getAuthToken } = await import('../../lib/auth');
    const expectedToken = getAuthToken(ADMIN_PASSWORD);
    isAuth = cookies.get('gh_admin_auth')?.value === expectedToken;
}

if (!isAuth) {
    return Astro.redirect('/admin/login');
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–∫—É—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö
let rates = { rub_rate: 280, usdt_rate: 25500, usd_rate: 25000, eur_rate: 27000, cny_rate: 3500 };

// –ó–∞–≥—Ä—É–∑–∫–∞ –∞–¥–º–∏–Ω–æ–≤ –∏–∑ .env (–ø–æ –Ω–æ–≤—ã–º –ø—Ä–∞–≤–∏–ª–∞–º)
let admins: number[] = [];
try {
    const adminIdsEnv = process.env.TELEGRAM_ADMIN_IDS || import.meta.env.TELEGRAM_ADMIN_IDS || '';
    admins = adminIdsEnv.split(',').map(id => parseInt(id.trim())).filter(id => !isNaN(id));
} catch (e) {
    console.warn('Error parsing admins from env:', e);
}

try {
    // Rates from Data Store (Supabase/JSON hybrid)
    const ratesData = await getCollection('rates');
    if (ratesData && !Array.isArray(ratesData)) {
         rates = ratesData as any;
    } else if (Array.isArray(ratesData) && ratesData.length > 0) {
        // Fallback –µ—Å–ª–∏ –≤–µ—Ä–Ω—É–ª—Å—è –º–∞—Å—Å–∏–≤ (—Å—Ç–∞—Ä–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ)
        const matched = (ratesData as any[]).reduce((acc, curr) => {
            acc[`${curr.id.toLowerCase()}_rate`] = curr.rate;
            return acc;
        }, {});
        rates = { ...rates, ...matched };
    }
} catch (error) {
    console.error('Error loading bot data:', error);
}
---

<AdminLayout title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ë–æ—Ç–∞">
    <div class="space-y-6">
        <div class="flex flex-col gap-2">
            <h1 class="text-4xl font-black text-slate-900 tracking-tight flex items-center gap-3">
                <span class="text-action"><i class="ri-robot-2-fill"></i></span>
                –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Telegram –ë–æ—Ç–∞
            </h1>
            <p class="text-slate-500 text-lg font-medium">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—É—Ä—Å–∞–º–∏ –≤–∞–ª—é—Ç –∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º–∏</p>
        </div>

        <!-- –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è —Ä–∞—Å–∫–ª–∞–¥–∫–∞ –¥–≤—É—Ö –±–ª–æ–∫–æ–≤ -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

        <!-- –ö—É—Ä—Å—ã –í–∞–ª—é—Ç -->
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="bg-gradient-to-r from-emerald-600 to-emerald-700 px-8 py-6">
                <h2 class="text-2xl font-bold text-white flex items-center gap-3">
                    <i class="ri-money-dollar-circle-fill text-3xl"></i>
                    –ö—É—Ä—Å—ã –í–∞–ª—é—Ç
                </h2>
            </div>
            
            <form id="ratesForm" class="p-8 space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">üá∑üá∫ –†—É–±–ª—å (RUB) ‚Üí VND</label>
                        <input 
                            type="number" 
                            name="rub_rate" 
                            value={rates.rub_rate}
                            class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200 transition-all font-semibold text-lg"
                            required
                        />
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">üíé USDT ‚Üí VND</label>
                        <input 
                            type="number" 
                            name="usdt_rate" 
                            value={rates.usdt_rate}
                            class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200 transition-all font-semibold text-lg"
                            required
                        />
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">üíµ –î–æ–ª–ª–∞—Ä (USD) ‚Üí VND</label>
                        <input 
                            type="number" 
                            name="usd_rate" 
                            value={rates.usd_rate}
                            class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200 transition-all font-semibold text-lg"
                            required
                        />
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">üá™üá∫ –ï–≤—Ä–æ (EUR) ‚Üí VND</label>
                        <input 
                            type="number" 
                            name="eur_rate" 
                            value={rates.eur_rate}
                            class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200 transition-all font-semibold text-lg"
                            required
                        />
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">üá®üá≥ –Æ–∞–Ω—å (CNY) ‚Üí VND</label>
                        <input 
                            type="number" 
                            name="cny_rate" 
                            value={rates.cny_rate}
                            class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200 transition-all font-semibold text-lg"
                            required
                        />
                    </div>
                </div>
                
                <div class="flex justify-end">
                    <button 
                        type="submit" 
                        class="btn-primary px-8 py-3 rounded-xl font-bold text-lg shadow-lg hover:shadow-xl transition-all flex items-center gap-2"
                    >
                        <i class="ri-save-line"></i>
                        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ö—É—Ä—Å—ã
                    </button>
                </div>
            </form>
        </div>

        <!-- –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã -->
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="bg-gradient-to-r from-slate-600 to-slate-700 px-8 py-6">
                <h2 class="text-2xl font-bold text-white flex items-center gap-3">
                    <i class="ri-admin-fill text-3xl"></i>
                    –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –ë–æ—Ç–∞
                </h2>
            </div>
            
            <div class="p-8 space-y-6">
                <div class="bg-indigo-50 border-2 border-indigo-100 rounded-2xl p-6 flex items-start gap-4">
                    <i class="ri-information-fill text-2xl text-indigo-500"></i>
                    <div>
                        <p class="text-indigo-900 font-bold mb-1">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ .env</p>
                        <p class="text-indigo-700 text-sm font-medium">
                            –°–ø–∏—Å–æ–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ —Ç–µ–ø–µ—Ä—å –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –≤ —Ñ–∞–π–ª–µ <code class="bg-indigo-200/50 px-2 py-0.5 rounded text-indigo-900">.env</code> –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π <code class="bg-indigo-200/50 px-2 py-0.5 rounded text-indigo-900">TELEGRAM_ADMIN_IDS</code>. 
                            –ò–∑–º–µ–Ω–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –ø–∞–Ω–µ–ª—å –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–µ–Ω–æ –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.
                        </p>
                    </div>
                </div>
                
                <div>
                    <h3 class="text-lg font-bold text-slate-800 mb-4">–¢–µ–∫—É—â–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã (ID):</h3>
                    <ul id="adminsList" class="space-y-2">
                        {admins.map((adminId) => (
                            <li class="flex items-center justify-between bg-slate-50 rounded-lg px-6 py-4 border border-slate-200">
                                <span class="font-mono text-lg font-bold text-slate-800">{adminId}</span>
                                <span class="text-slate-400 text-sm italic">–ê–∫—Ç–∏–≤–µ–Ω</span>
                            </li>
                        ))}
                    </ul>
                </div>
            </div>
        </div>
        </div>
    </div>

    <script is:inline define:vars={{ initialAdmins: admins }}>
        let currentAdmins = initialAdmins;

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫—É—Ä—Å–æ–≤
        document.getElementById('ratesForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const rates = {
                rub_rate: parseInt(formData.get('rub_rate')),
                usdt_rate: parseInt(formData.get('usdt_rate')),
                usd_rate: parseInt(formData.get('usd_rate')),
                eur_rate: parseInt(formData.get('eur_rate')),
                cny_rate: parseInt(formData.get('cny_rate')),
            };
            
            try {
                const res = await fetch('/api/bot/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type: 'rates', payload: rates })
                });
                
                if (res.ok) {
                    showToast('‚úÖ –ö—É—Ä—Å—ã —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã!', 'success');
                } else {
                    showToast('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫—É—Ä—Å–æ–≤', 'error');
                }
            } catch (error) {
                console.error(error);
                showToast('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error');
            }
        });

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
        document.getElementById('addAdminForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const newId = parseInt(document.getElementById('newAdminId').value);
            
            if (currentAdmins.includes(newId)) {
                showToast('‚ö†Ô∏è –≠—Ç–æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω', 'info');
                return;
            }
            
            currentAdmins.push(newId);
            await saveAdmins();
            document.getElementById('newAdminId').value = '';
        });

        // –£–¥–∞–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
        window.removeAdmin = async (adminId) => {
            const confirmed = await showConfirm(`–£–¥–∞–ª–∏—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ ${adminId}?`, '–£–¥–∞–ª–µ–Ω–∏–µ');
            if (!confirmed) return;
            
            currentAdmins = currentAdmins.filter(id => id !== adminId);
            await saveAdmins();
        };

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
        async function saveAdmins() {
            try {
                const res = await fetch('/api/bot/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type: 'admins', payload: currentAdmins })
                });
                
                if (res.ok) {
                    location.reload();
                } else {
                    showToast('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤', 'error');
                }
            } catch (error) {
                console.error(error);
                showToast('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error');
            }
        }
    </script>
</AdminLayout>
