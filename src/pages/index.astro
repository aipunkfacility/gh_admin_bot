---
import MainLayout from '../layouts/MainLayout.astro';
import Hero from '../components/Hero.astro';
import Popular from '../sections/Popular.astro';
import Excursions from '../sections/Excursions.astro';
import Services from '../sections/Services.astro';
import Transport from '../sections/Transport.astro';
import Accommodations from '../sections/Accommodations.astro';
import Contacts from '../sections/Contacts.astro';
import CurrencyRates from '../sections/CurrencyRates.astro';

import { getCollection, getItem } from '../lib/data-store';
import type { Excursion, TransportItem, Accommodation, Service, TransportCategory } from '../lib/types';

interface Section {
    id: string;
    enabled: boolean;
}

interface CommonItem {
    id: string;
    isPopular?: boolean;
    isActive?: boolean;
    [key: string]: unknown;
}

// Загрузка данных параллельно
const [
    siteMetaResult,
    excursionsRaw,
    transportRaw,
    accommodationsRaw,
    servicesRaw,
    allTransportCategories
] = await Promise.all([
    getItem('site-meta.json', 'site-meta'),
    getCollection('excursions.json'),
    getCollection('transport-items.json'),
    getCollection('accommodations.json'),
    getCollection('services.json'),
    getCollection('transport-categories.json')
]);

const siteMeta = (siteMetaResult || {}) as Record<string, unknown>;
const transportCategories = (((allTransportCategories || []) as CommonItem[]).filter(c => c.isActive !== false)) as unknown as TransportCategory[];

const excursions = (excursionsRaw || []) as Excursion[];
const transport = (transportRaw || []) as TransportItem[];
const accommodations = (accommodationsRaw || []) as Accommodation[];
const services = (servicesRaw || []) as Service[];

// Популярные элементы
const popularItems: Array<Excursion | (TransportItem & { type: string }) | Accommodation | Service> = [
    ...excursions.filter(i => i.isPopular && i.isActive !== false),
    ...transport.filter(i => i.isPopular && i.isActive !== false).map(i => ({...i, type: 'transport'})),
    ...accommodations.filter(i => i.isPopular && i.isActive !== false),
    ...services.filter(i => i.isPopular && i.isActive !== false),
];

const activeExcursions = excursions.filter(i => i.isActive !== false);
const activeTransport = transport.filter(i => i.isActive !== false);
const activeAccommodations = accommodations.filter(i => i.isActive !== false);
const activeServices = services.filter(i => i.isActive !== false);

const defaultSections: Section[] = [
    { id: 'popular', enabled: true },
    { id: 'excursions', enabled: true },
    { id: 'transport', enabled: true },
    { id: 'accommodations', enabled: true },
    { id: 'services', enabled: true },
    { id: 'contacts', enabled: true },
];

const sections = (siteMeta.sections as Section[]) || defaultSections;
---

<MainLayout 
    title={(siteMeta.mainTitle as string) || "Green Hill Tours"} 
    description={(siteMeta.mainSubtitle as string) || "Экскурсии и аренда транспорта в Муйне"}
    sections={sections as unknown as Array<{id: string; label: string; icon: string; enabled: boolean}>}
>
    <Hero 
        mainTitle={(siteMeta.mainTitle as string) || "Green Hill Tours"}
        mainSubtitle={(siteMeta.mainSubtitle as string) || "Лучшие экскурсии и аренда транспорта в Муйне"}
    />

    {sections.map((section) => {
        if (!section.enabled) return null;
        
        if (section.id === 'popular' && popularItems.length > 0) {
            return <Popular items={popularItems as any} categories={transportCategories} />;
        }
        if (section.id === 'excursions' && activeExcursions.length > 0) {
            return <Excursions excursions={activeExcursions} />;
        }
        if (section.id === 'transport' && activeTransport.length > 0) {
             {/* @ts-expect-error - Category casting */}
            return <Transport categories={transportCategories} transportItems={activeTransport} />;
        }
        if (section.id === 'services' && activeServices.length > 0) {
            return <Services services={activeServices} />;
        }
        if (section.id === 'accommodations' && activeAccommodations.length > 0) {
            return <Accommodations accommodations={activeAccommodations} />;
        }
        if (section.id === 'contacts') {
             {/* @ts-expect-error - SiteMeta casting */}
            return <Contacts siteMeta={siteMeta} />;
        }
        if (section.id === 'currency') {
            return <CurrencyRates />;
        }
        return null;
    })}

    <script is:inline>
        /**
         * WhatsApp и Аккордеон
         */
        function openWhatsApp(message = '') {
            const phone = '84123456789'; 
            window.open(`https://wa.me/${phone}?text=${encodeURIComponent(message)}`, '_blank');
        }

        function toggleServiceAccordion(element) {
            const isCurrentlyOpen = element.classList.contains('is-open');
            document.querySelectorAll('.service-card.is-open').forEach(card => card.classList.remove('is-open'));
            if (!isCurrentlyOpen) element.classList.add('is-open');
        }

        window.openWhatsApp = openWhatsApp;
        window.toggleServiceAccordion = toggleServiceAccordion;
    </script>
</MainLayout>
