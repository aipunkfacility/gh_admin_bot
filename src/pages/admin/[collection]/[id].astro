---
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { schemas } from '../../../lib/schemas';
import { getItem } from '../../../lib/data-store';

const cookies = Astro.cookies;
const ADMIN_PASSWORD = import.meta.env.ADMIN_PASSWORD;

let isAuth = false;
if (ADMIN_PASSWORD) {
    const { getAuthToken } = await import('../../../lib/auth');
    const expectedToken = getAuthToken(ADMIN_PASSWORD);
    isAuth = cookies.get('gh_admin_auth')?.value === expectedToken;
}

if (!isAuth) {
    return Astro.redirect('/admin/login');
}

const { collection, id } = Astro.params;
const isCreate = !id || id === 'create';

const collectionNames = {
    'excursions': '–≠–∫—Å–∫—É—Ä—Å–∏–∏',
    'transport-items': '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç',
    'accommodations': '–ñ–∏–ª—å–µ',
    'services': '–£—Å–ª—É–≥–∏',
    'posts': '–ü–æ—Å—Ç—ã',
    'site-meta': '–ù–∞—Å—Ç—Ä–æ–π–∫–∏'
} as const;

type CollectionKey = keyof typeof collectionNames;
const collectionTitle = (collection && collection in collectionNames) ? collectionNames[collection as CollectionKey] : collection;

// Redirect if schema not found
const schema = collection ? schemas[collection] : undefined;
if (!schema) {
    return Astro.redirect('/admin');
}

interface ItemData {
    id?: string;
    title?: string;
    [key: string]: any;
}

let item: ItemData = {};
if (!isCreate && id && collection) {
    const fetched = await getItem(collection + '.json', id);
    if (!fetched) {
        return Astro.redirect(`/admin/${collection}`);
    }
    item = fetched as ItemData;
} else {
    // Default values
    schema.fields.forEach((f: any) => {
        if (f.default !== undefined) item[f.name] = f.default;
    });
}

// --- Dynamic Categories for Selection ---
if (collection === 'excursions' || collection === 'transport-items') {
    const catCollection = collection === 'excursions' ? 'excursion-categories' : 'transport-categories';
    try {
        const categories = await getCollection(catCollection);
        const categoryField = schema.fields.find(f => f.name === 'categoryId');
        if (categoryField && Array.isArray(categories)) {
            categoryField.options = categories.map(cat => ({
                value: cat.slug || cat.id,
                label: cat.title
            }));
            // Add UUID as fallback for existing data that might be UUID-based
            categories.forEach(cat => {
                if (cat.id && cat.id !== cat.slug) {
                    (categoryField.options as any).push({ value: cat.id, label: `${cat.title} (UUID)` });
                }
            });
        }
    } catch (e) {
        console.error('Error fetching dynamic categories:', e);
    }
}

// Helper to get nested value (e.g. contacts.telegram)
const getValue = (obj: any, path: string): any => {
    return path.split('.').reduce((acc, part) => acc && acc[part], obj);
};

// Helper to normalize image paths for preview
const normalizeSrc = (src: string): string => {
    if (!src) return '';
    if (src.startsWith('http') || src.startsWith('/')) return src;
    if (src.startsWith('./')) return src.replace('./', '/');
    return '/' + src;
};

// --- Field Separation Logic ---
const sidebarFieldNames = [
    'isActive', 'isPopular', 'status', 
    'pricePerDay', 'pricePerMonth', 'priceFrom', 'priceStart', 'deposit', 'duration',
    'categoryId', 
    'image', 'tgImage', 'tgMessageId'
];

interface Field {
    name: string;
    label: string;
    type: string;
    required?: boolean;
    default?: any;
    options?: any;
    rows?: number;
    colSpan?: number;
    readOnly?: boolean;
    placeholder?: string;
}

const mainFields = schema.fields.filter((f: any) => !sidebarFieldNames.includes(f.name));
const sidebarFields = schema.fields
    .filter((f: any) => sidebarFieldNames.includes(f.name))
    .sort((a: any, b: any) => sidebarFieldNames.indexOf(a.name) - sidebarFieldNames.indexOf(b.name));

const showTgCard = (!isCreate && collection && ['excursions', 'transport-items', 'accommodations', 'posts', 'services'].includes(collection));
const showSettingsCard = sidebarFields.some((f: Field) => !f.name.startsWith('tg'));
const hasSidebar = showTgCard || showSettingsCard;

const hasPdfUpload = collection === 'transport-items'; // Example feature toggle if needed
---

<AdminLayout title={isCreate ? '–°–æ–∑–¥–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞' : '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ'}>
    <form id="editForm" class="max-w-7xl mx-auto pb-20 relative">
        
        {/* --- STICKY HEADER --- */}
        <div class="max-w-6xl mx-auto">
        <!-- Sticky Header -->
        <div class="sticky top-0 z-40 bg-white/80 backdrop-blur-md border-b border-slate-200 -mx-6 px-6 py-4 mb-8 flex items-center justify-between transition-all">
            <div class="flex items-center gap-4">
                <a href={`/admin/${collection}`} class="w-10 h-10 flex items-center justify-center bg-slate-100 rounded-full text-slate-500 hover:bg-slate-200 transition-colors">
                    <i class="ri-arrow-left-line text-lg"></i>
                </a>
                <div>
                    <div class="text-[10px] font-black uppercase tracking-widest text-slate-400 mb-0.5">
                        {collectionTitle}
                    </div>
                    <h1 class="text-xl font-extrabold text-dark tracking-tight leading-none">
                        {isCreate ? '‚ú® –ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å' : item.title || '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ'}
                    </h1>
                </div>
            </div>
            
            <div class="flex items-center gap-3">
                {!isCreate && collection !== 'site-meta' && (
                    <button 
                        type="button" 
                        id="headerSyncBtn"
                        class="px-4 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-xl font-bold shadow-lg shadow-blue-500/20 transition-all active:scale-[98%] flex items-center justify-center border border-blue-400"
                        title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram"
                    >
                        <i class="ri-telegram-fill text-xl"></i>
                        <span class="hidden sm:inline ml-2 text-xs uppercase tracking-widest">TG Sync</span>
                    </button>
                )}

                 <button type="button" id="headerSaveBtn" class="px-8 py-3 bg-action hover:bg-action-hover text-white text-[10px] font-black uppercase tracking-widest rounded-xl shadow-xl shadow-orange-500/20 transition-all active:scale-[98%] flex items-center gap-2">
                    <i class="ri-save-line text-lg"></i>
                    <span>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</span>
                </button>
            </div>
        </div>

        <div class={`grid grid-cols-1 ${hasSidebar ? 'lg:grid-cols-3' : ''} gap-8`}>
            
            {/* --- MAIN COLUMN (LEFT) --- */}
            <div class={`${hasSidebar ? 'lg:col-span-2' : 'w-full'} space-y-6`}>
                
                {/* Content Card */}
                <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-sm border border-slate-200 space-y-6">
                    <div class="flex items-center gap-2 mb-4">
                        <span class="w-1 h-6 bg-action rounded-full"></span>
                        <h2 class="text-lg font-bold text-dark">–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h2>
                    </div>

                    {collection === 'site-meta' ? (
                        <div class="space-y-6">
                            {/* --- SITE SETTINGS LAYOUT --- */}
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-start">
                                
                                {/* Card 1: Main Info */}
                                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 space-y-4 h-full">
                                    <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest border-b border-slate-100 pb-2 mb-4">–ò–Ω—Ñ–æ</h3>
                                    {mainFields.filter(f => ['mainTitle', 'mainSubtitle'].includes(f.name)).map(field => (
                                        <div class="space-y-1">
                                            <label class="block text-[10px] font-black text-slate-500 uppercase tracking-widest ml-1 mb-1">
                                                {field.label}
                                            </label>
                                            {field.type === 'textarea' ? (
                                                <textarea name={field.name} rows={4} class="w-full px-5 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-action/20 focus:border-action transition-all font-semibold text-dark placeholder:text-slate-300">{getValue(item, field.name) || ''}</textarea>
                                            ) : (
                                                <input type="text" name={field.name} value={getValue(item, field.name) || ''} class="w-full px-5 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-action/20 focus:border-action transition-all font-semibold text-dark placeholder:text-slate-300" />
                                            )}
                                        </div>
                                    ))}

                                    {/* Copyright Year */}
                                    {mainFields.filter(f => f.name === 'copyrightYear').map(field => (
                                        <div class="space-y-1">
                                            <label class="block text-[10px] font-black text-slate-500 uppercase tracking-widest ml-1 mb-1">
                                                {field.label}
                                            </label>
                                            <input type="text" name={field.name} value={getValue(item, field.name) || ''} class="w-full px-5 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-action/20 focus:border-action transition-all font-semibold text-dark placeholder:text-slate-300" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 2026" />
                                        </div>
                                    ))}
                                </div>

                                {/* Card 2: Contacts */}
                                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 space-y-4 h-full">
                                    <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest border-b border-slate-100 pb-2 mb-4">–ö–æ–Ω—Ç–∞–∫—Ç—ã</h3>
                                    {mainFields.filter(f => !['mainTitle', 'mainSubtitle', 'contacts.offices', 'copyrightYear'].includes(f.name)).map(field => (
                                        <div class="space-y-1">
                                            <label class="block text-[10px] font-black text-slate-500 uppercase tracking-widest ml-1 mb-1">
                                                {field.label}
                                            </label>
                                            <input type="text" name={field.name} value={getValue(item, field.name) || ''} class="w-full px-5 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-action/20 focus:border-action transition-all font-semibold text-dark placeholder:text-slate-300" />
                                        </div>
                                    ))}

                                    {/* Copyright Year Removed */}
                                </div>
                            </div>

                            {/* Card 3: Offices (Full Width) */}
                            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 space-y-4">
                                <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest border-b border-slate-100 pb-2 mb-4">–û—Ñ–∏—Å—ã</h3>
                                {mainFields.filter(f => f.name === 'contacts.offices').map(field => (
                                      <div class="offices-editor space-y-4" data-name={field.name} data-initial={JSON.stringify(getValue(item, field.name) || [])}>
                                          <div class="offices-list grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                                          <button type="button" class="add-office-btn w-full py-3 border-2 border-dashed border-slate-200 rounded-xl text-slate-400 font-bold text-xs uppercase hover:border-action hover:text-action transition-all">
                                              + –î–æ–±–∞–≤–∏—Ç—å –æ—Ñ–∏—Å
                                          </button>
                                      </div>
                                ))}
                            </div>
                        </div>
                    ) : (
                        /* --- GENERIC GRID LAYOUT --- */
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                            {mainFields.map((field: any) => (
                                <div class={`space-y-1 ${String(field.colSpan) === '1' ? 'col-span-1' : 'col-span-1 md:col-span-2'}`}>
                                    {field.type !== 'checkbox' && (
                                    <label class="block text-[10px] font-black text-slate-500 uppercase tracking-widest ml-1 mb-1">
                                        {field.label} {field.required && <span class="text-action">*</span>}
                                    </label>
                                    )}
                                    
                                    {field.type === 'text' && (
                                        <input type="text" name={field.name} value={getValue(item, field.name) || ''} required={field.required}
                                            class="w-full px-5 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-action/20 focus:border-action transition-all font-semibold text-dark placeholder:text-slate-300" />
                                    )}

                                    {field.type === 'textarea' && (
                                        <textarea name={field.name} rows={field.rows || 4} required={field.required}
                                            class="w-full px-5 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-action/20 focus:border-action transition-all font-semibold text-dark placeholder:text-slate-300">{getValue(item, field.name) || ''}</textarea>
                                    )}
                                    
                                    {field.type === 'array' && (
                                        <textarea name={field.name} rows={field.rows || 4} data-type="array"
                                            class="w-full px-5 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-action/20 focus:border-action transition-all font-semibold text-dark placeholder:text-slate-300"
                                            placeholder="–ö–∞–∂–¥—ã–π —ç–ª–µ–º–µ–Ω—Ç —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏">{(() => {
                                                const val = getValue(item, field.name);
                                                if (Array.isArray(val)) return val.join('\n');
                                                return val || '';
                                            })()}</textarea>
                                    )}
                                    
                                    {field.type === 'offices' && (
                                        <div class="offices-editor space-y-4" data-name={field.name} data-initial={JSON.stringify(getValue(item, field.name) || [])}>
                                            <div class="offices-list grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                                            <button type="button" class="add-office-btn px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-600 text-xs font-bold uppercase tracking-wider rounded-lg transition-colors">
                                                + –î–æ–±–∞–≤–∏—Ç—å –æ—Ñ–∏—Å
                                            </button>
                                        </div>
                                    )}
                                    
                                    {field.type === 'checkbox' && (
                                        <div class="flex items-center gap-3 pt-6 border-t border-slate-100 mt-2">
                                            <label class="relative inline-flex items-center cursor-pointer">
                                                <input type="checkbox" name={field.name} class="sr-only peer" checked={getValue(item, field.name)} />
                                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-action/20 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-action"></div>
                                            </label>
                                            <span class="text-sm font-bold text-dark select-none cursor-pointer" onclick="this.previousElementSibling.click()">{field.label}</span>
                                        </div>
                                    )}
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            </div>

            {/* --- SIDEBAR (RIGHT) --- */}
            {hasSidebar && (
            <div class="space-y-6">
                
                {/* 1. Media & Status Card */}
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 space-y-6">
                     <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest border-b border-slate-100 pb-2">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
                                            <div class="grid grid-cols-2 gap-4">
                        {sidebarFields.map((field: any) => {
                            // Skip Telegram fields here
                            if (field.name.startsWith('tg')) return null;

                            // Determine column span
                            const colSpan = field.colSpan === 1 ? 'col-span-1' : 'col-span-2';

                            return (
                                <div class={`space-y-1 ${colSpan}`}>
                                    {field.type !== 'checkbox' && (
                                        <label class="block text-[10px] font-black text-slate-500 uppercase tracking-widest ml-1">
                                            {field.label} {field.required && <span class="text-action">*</span>}
                                        </label>
                                    )}

                                    {field.type === 'image' && (
                                        <div class="space-y-4 image-upload-group">
                                            <div class="flex flex-col gap-3">
                                                 <div class="preview-container hidden rounded-xl overflow-hidden border border-slate-200 w-full aspect-video bg-slate-100 relative shadow-sm group">
                                                    <img src="" class="w-full h-full object-cover" />
                                                </div>
                                                
                                                <div class="flex gap-2">
                                                    <input type="text" name={field.name} value={getValue(item, field.name) || ''} 
                                                        class="image-path-input w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-xs font-semibold text-dark focus:outline-none focus:border-[#16a34a] transition-all" 
                                                        placeholder="/images/..." />
                                                    <button type="button" class="upload-trigger-btn w-12 h-10 flex-shrink-0 flex items-center justify-center bg-slate-100 hover:bg-[#16a34a]/10 text-slate-500 hover:text-[#16a34a] rounded-xl transition-all shadow-sm active:scale-95 border border-slate-200">
                                                        <i class="ri-image-add-line text-lg"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                    
                                    {field.type === 'checkbox' && (
                                        <label class="flex items-center gap-3 p-3 cursor-pointer group hover:bg-slate-50 rounded-xl transition-colors border border-transparent hover:border-slate-100">
                                            <div class="relative flex items-center">
                                                <input type="checkbox" name={field.name} checked={!!getValue(item, field.name)}
                                                    class="peer sr-only" />
                                                <div class="w-6 h-6 bg-white border-2 border-slate-300 rounded-lg text-white flex items-center justify-center peer-checked:bg-[#16a34a] peer-checked:border-[#16a34a] transition-all shadow-sm">
                                                    <i class="ri-check-line opacity-0 peer-checked:opacity-100 text-sm font-bold"></i>
                                                </div>
                                            </div>
                                            <span class="text-[10px] font-black uppercase tracking-widest text-slate-500 group-hover:text-[#16a34a] transition-colors select-none">
                                                {field.label}
                                            </span>
                                        </label>
                                    )}

                                    {field.type === 'select' && (
                                          <div class="relative">
                                            <select name={field.name} class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-action/20 focus:border-action transition-all font-bold text-dark text-xs appearance-none">
                                                <option value="">‚Äî</option>
                                                {field.options && field.options.map((opt: any) => {
                                                    const optValue = typeof opt === 'object' ? opt.value : opt;
                                                    const optLabel = typeof opt === 'object' ? opt.label : opt;
                                                    return (
                                                        <option value={optValue} selected={getValue(item, field.name) === optValue}>{optLabel}</option>
                                                    );
                                                })}
                                            </select>
                                            <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-slate-500">
                                                <i class="ri-arrow-down-s-line"></i>
                                            </div>
                                          </div>
                                    )}
                                    
                                    {field.type === 'text' && (
                                         <input type="text" name={field.name} value={getValue(item, field.name) || ''}
                                            class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-action/20 focus:border-action transition-all font-bold text-dark text-xs" />
                                    )}
                                </div>
                            );
                         })}
                      </div>
                </div>

                {/* 2. Telegram Card */}
                {showTgCard && (
                    <div class="bg-gradient-to-br from-white to-blue-50/50 p-6 rounded-2xl shadow-sm border border-blue-100 space-y-6 relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-16 h-16 bg-blue-500/10 rounded-bl-full -mr-8 -mt-8"></div>
                        
                        <div class="flex items-center gap-2 border-b border-blue-100 pb-2">
                             <i class="ri-telegram-fill text-blue-500 text-xl"></i>
                             <h3 class="text-xs font-black text-blue-500 uppercase tracking-widest">Telegram</h3>
                        </div>

                         {/* Render Telegram Fields */}
                         {sidebarFields.filter((f: any) => f.name.startsWith('tg')).map((field: any) => (
                             <div class="space-y-2">
                                <label class="block text-[10px] font-black text-slate-500 uppercase tracking-widest ml-1">
                                    {field.label}
                                </label>
                                
                                {field.type === 'image' && (
                                     <div class="space-y-4 image-upload-group">
                                        <div class="flex flex-col gap-3">
                                             <div class="preview-container hidden rounded-xl overflow-hidden border border-slate-200 w-full aspect-video bg-white relative shadow-sm">
                                                <img src="" class="w-full h-full object-cover" />
                                            </div>
                                             <div class="flex gap-2">
                                                <input type="text" name={field.name} value={getValue(item, field.name) || ''} 
                                                    class="image-path-input w-full px-4 py-2 bg-white border border-slate-200 rounded-lg text-xs font-semibold text-dark focus:outline-none focus:border-blue-500" 
                                                    placeholder="–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é (–æ—Å–Ω. —Ñ–æ—Ç–æ)" />
                                                <button type="button" class="upload-trigger-btn w-12 h-10 flex-shrink-0 flex items-center justify-center bg-slate-100 hover:bg-[#16a34a]/10 text-slate-500 hover:text-[#16a34a] rounded-lg transition-all shadow-sm active:scale-95 border border-slate-200">
                                                     <i class="ri-image-add-line text-lg"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                )}
                                
                                {field.type === 'text' && (
                                     <input type="text" name={field.name} value={getValue(item, field.name) || ''} readonly={field.readOnly}
                                        class="w-full px-4 py-2 bg-slate-100 border border-slate-200 rounded-xl text-xs font-mono text-slate-500" />
                                )}
                             </div>
                         ))}

                    </div>
                )}
                
                {/* 3. Delete Zone */}
                {!isCreate && collection !== 'site-meta' && (
                    <div class="bg-rose-50 p-6 rounded-2xl border border-rose-100 space-y-4">
                        <h3 class="text-xs font-black text-rose-400 uppercase tracking-widest">–û–ø–∞—Å–Ω–∞—è –∑–æ–Ω–∞</h3>
                        <button type="button" id="deleteBtn" class="w-full flex items-center justify-center gap-2 px-6 py-3 bg-white border border-rose-200 hover:bg-rose-500 hover:text-white text-rose-500 text-[10px] font-black uppercase tracking-widest rounded-xl transition-all">
                            –£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å
                        </button>
                    </div>
                )}
            </div>
            )}
        </div>
    </form>

    <script define:vars={{ collection, id, isCreate }}>
        const form = document.getElementById('editForm');
        
        // Delete functionality
        const deleteBtn = document.getElementById('deleteBtn');
        if (deleteBtn) {
            deleteBtn.addEventListener('click', async () => {
                const confirmed = await showConfirm('–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –ù–ï–û–ë–†–ê–¢–ò–ú–û!\n\n–í—ã —Ç–æ—á–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å?', '‚ö†Ô∏è –£–¥–∞–ª–µ–Ω–∏–µ');
                if (!confirmed) return;
                try {
                    const res = await fetch(`/api/${collection}/${id}`, { method: 'DELETE' });
                    if (res.ok) {
                        showToast('–ó–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞', 'success');
                        setTimeout(() => window.location.href = `/admin/${collection}`, 1000);
                    } else {
                        showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏', 'error');
                    }
                } catch (e) {
                    showToast('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error');
                }
            });
        }
        
        // Sync TG functionality (Shared Logic)
        const setupSyncButton = (btnId) => {
            const btn = document.getElementById(btnId);
            if (!btn) return;

            btn.addEventListener('click', async () => {
                const tgIdField = form.querySelector('input[name="tgMessageId"]');
                const hasExistingPost = tgIdField && tgIdField.value && tgIdField.value !== '';
                
                let confirmMsg = '–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä –≤ Telegram –∫–∞–Ω–∞–ª–µ?';
                if (hasExistingPost) {
                    confirmMsg = '–í–ù–ò–ú–ê–ù–ò–ï: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –û–ë–ù–û–í–ò–¢ —Ç–µ–∫—É—â–∏–π –ø–æ—Å—Ç –≤ Telegram. \n\n–í–∞—à–∏ —Ä—É—á–Ω—ã–µ –ø—Ä–∞–≤–∫–∏ –≤ –∫–∞–Ω–∞–ª–µ (–µ—Å–ª–∏ –æ–Ω–∏ –±—ã–ª–∏) –±—É–¥—É—Ç –∑–∞—Ç–µ—Ä—Ç—ã —Ç–µ–∫—Å—Ç–æ–º –∏–∑ –∞–¥–º–∏–Ω–∫–∏. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?';
                }

                const confirmed = await showConfirm(confirmMsg, 'üì¢ Telegram Sync');
                if (!confirmed) return;
                
                const originalContent = btn.innerHTML;
                btn.innerHTML = '<i class="ri-loader-4-line animate-spin"></i>';
                btn.disabled = true;
                
                try {
                    const res = await fetch(`/api/bot/sync-channel`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ collection, id })
                    });
                    
                    const result = await res.json();
                    
                    if (res.ok) {
                        if (result.warning) {
                            showToast(result.warning, 'warning');
                        } else {
                            showToast(result.message || '–£—Å–ø–µ—à–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ!', 'success');
                        }
                        // –î–∞–µ–º –≤—Ä–µ–º—è –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ç–æ—Å—Ç –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–æ–π
                        setTimeout(() => location.reload(), result.warning ? 3000 : 1500);
                    } else {
                        showToast('–û—à–∏–±–∫–∞: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
                    }
                } catch (e) {
                    console.error(e);
                    showToast('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏', 'error');
                } finally {
                    btn.innerHTML = originalContent;
                    btn.disabled = false;
                }
            });
        };

        // Initialize buttons (both header and sidebar)
        setupSyncButton('syncTgBtn');
        setupSyncButton('headerSyncBtn');
        
        // Header Save Button Logic
        const headerSaveBtn = document.getElementById('headerSaveBtn');
        if (headerSaveBtn) {
            headerSaveBtn.addEventListener('click', () => {
                form.requestSubmit();
            });
        }
        
        // Logic for Image Previews
        const normalizeSrc = (src) => {
            if (!src) return '';
            if (src.startsWith('http') || src.startsWith('/')) return src;
            if (src.startsWith('./')) return src.replace('./', '/');
            return '/' + src;
        };

        // Initialize previews on load
        document.querySelectorAll('.image-path-input').forEach(input => {
            const updatePreview = () => {
                const parent = input.closest('.space-y-4');
                const preview = parent.querySelector('.preview-container');
                const img = preview.querySelector('img');
                if (input.value) {
                    img.src = normalizeSrc(input.value);
                    preview.classList.remove('hidden');
                    preview.classList.add('block');
                } else {
                    preview.classList.add('hidden');
                    preview.classList.remove('block');
                }
            };
            
            // Run on load
            updatePreview();
            
            // Run on change
            input.addEventListener('input', updatePreview);
        });

        // Upload Logic
        document.querySelectorAll('.upload-trigger-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const parentDiv = btn.closest('.image-upload-group'); // Fix scope using dedicated class
                const textInput = parentDiv.querySelector('.image-path-input');
                const previewContainer = parentDiv.querySelector('.preview-container');
                const imgPreview = previewContainer.querySelector('img');
                
                // Create hidden file input
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = 'image/*';
                fileInput.style.display = 'none';
                document.body.appendChild(fileInput);
                
                fileInput.click();
                
                fileInput.onchange = async () => {
                    const file = fileInput.files[0];
                    if (!file) return;
                    
                    const formData = new FormData();
                    formData.append('file', file);
                    
                    const originalHTML = btn.innerHTML;
                    btn.innerHTML = '‚è≥';
                    btn.disabled = true;
                    
                    try {
                        const res = await fetch('/api/upload', {
                            method: 'POST',
                            body: formData
                        });
                        
                        const data = await res.json();
                        
                        if (data.success) {
                            textInput.value = data.url;
                            // Trigger event to update preview
                            textInput.dispatchEvent(new Event('input'));
                            showToast('–§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ!', 'success');
                        } else {
                            alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                        }
                    } catch (e) {
                        console.error('Upload network error:', e);
                        alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ: ' + e.message);
                    } finally {
                        btn.innerHTML = originalHTML;
                        btn.disabled = false;
                        document.body.removeChild(fileInput);
                    }
                };
            });
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(form);
            const data = {};

            // Handle nested keys and checkboxes
            for (let [key, value] of formData.entries()) {
                if (key.includes('.')) {
                    const [parent, child] = key.split('.');
                    if (!data[parent]) data[parent] = {};
                    data[parent][child] = value;
                } else {
                    data[key] = value;
                }
            }

            // Handle checkboxes explicitly
            const checkboxes = form.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => {
                data[cb.name] = cb.checked;
            });
            
            // Handle array fields (textarea with data-type="array")
            form.querySelectorAll('textarea[data-type="array"]').forEach(ta => {
                const name = ta.name;
                const lines = ta.value.split('\n').map(l => l.trim()).filter(l => l);
                data[name] = lines;
            });
            
            // Handle offices editor
            document.querySelectorAll('.offices-editor').forEach(editor => {
                const fieldName = editor.dataset.name;
                const offices = [];
                editor.querySelectorAll('.office-item').forEach(item => {
                    offices.push({
                        name: item.querySelector('[data-field="name"]').value,
                        address: item.querySelector('[data-field="address"]').value,
                        mapLink: item.querySelector('[data-field="mapLink"]').value
                    });
                });
                // Set nested value for contacts.offices
                if (fieldName.includes('.')) {
                    const [parent, child] = fieldName.split('.');
                    if (!data[parent]) data[parent] = {};
                    data[parent][child] = offices;
                } else {
                    data[fieldName] = offices;
                }
            });
            
            if (!isCreate) {
                data.id = id;
            } else if (!data.id) {
                // Generate slug if new
                data.id = (data.slug || String(Date.now()));
            }

            try {
                const url = `/api/${collection}/${data.id}`; 
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (res.ok) {
                    showToast('–ó–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!', 'success');
                    if (isCreate || collection === 'site-meta') {
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        // Stay on page for other collections
                    }
                } else {
                    const errData = await res.json();
                    showToast('–û—à–∏–±–∫–∞: ' + (errData.error || '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ'), 'error');
                }
            } catch (err) {
                console.error(err);
                showToast('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error');
            }
        });
        
        // Initialize offices editors
        function createOfficeItem(office = {}) {
            const div = document.createElement('div');
            div.className = 'office-item p-4 bg-slate-50 rounded-xl border border-slate-200 space-y-3';
            div.innerHTML = `
                <div class="flex justify-between items-center">
                    <span class="text-xs font-bold text-slate-500 uppercase">–û—Ñ–∏—Å</span>
                    <button type="button" class="remove-office text-red-400 hover:text-red-600 text-xs font-bold">–£–¥–∞–ª–∏—Ç—å</button>
                </div>
                <input type="text" data-field="name" value="${office.name || ''}" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –æ—Ñ–∏—Å–∞" 
                    class="w-full px-4 py-2 bg-white border border-slate-200 rounded-lg text-sm font-semibold" />
                <input type="text" data-field="address" value="${office.address || ''}" placeholder="–ê–¥—Ä–µ—Å" 
                    class="w-full px-4 py-2 bg-white border border-slate-200 rounded-lg text-sm font-semibold" />
                <input type="text" data-field="mapLink" value="${office.mapLink || ''}" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞—Ä—Ç—É (Google Maps)" 
                    class="w-full px-4 py-2 bg-white border border-slate-200 rounded-lg text-sm font-semibold" />
            `;
            div.querySelector('.remove-office').onclick = () => div.remove();
            return div;
        }
        
        document.querySelectorAll('.offices-editor').forEach(editor => {
            const list = editor.querySelector('.offices-list');
            const addBtn = editor.querySelector('.add-office-btn');
            const initial = JSON.parse(editor.dataset.initial || '[]');
            
            initial.forEach(office => list.appendChild(createOfficeItem(office)));
            addBtn.onclick = () => list.appendChild(createOfficeItem());
        });
    </script>
</AdminLayout>
