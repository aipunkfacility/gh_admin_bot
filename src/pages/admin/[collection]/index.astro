---
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { getCollection } from '../../../lib/data-store';

const cookies = Astro.cookies;
const ADMIN_PASSWORD = import.meta.env.ADMIN_PASSWORD;

let isAuth = false;
if (ADMIN_PASSWORD) {
    const { getAuthToken } = await import('../../../lib/auth');
    const expectedToken = getAuthToken(ADMIN_PASSWORD);
    isAuth = cookies.get('gh_admin_auth')?.value === expectedToken;
}

if (!isAuth) {
    return Astro.redirect('/admin/login');
}

const { collection } = Astro.params;

// Redirect old category pages to new Sections view
if (collection === 'excursion-categories' || collection === 'transport-categories') {
    return Astro.redirect('/admin/sections');
}

const collectionNames = {
    'excursions': 'Экскурсии',
    'transport-items': 'Транспорт',
    'accommodations': 'Жилье',
    'services': 'Услуги',
    'site-meta': 'Настройки',
    'excursion-categories': 'Категории туров',
    'transport-categories': 'Категории транспорта'
};

const collectionIcons = {
    'excursions': '<i class="ri-caravan-fill text-action"></i>',
    'transport-items': '<i class="ri-roadster-fill text-action"></i>',
    'accommodations': '<i class="ri-hotel-fill text-action"></i>',
    'services': '<i class="ri-customer-service-2-fill text-action"></i>',
    'site-meta': '<i class="ri-settings-4-fill text-action"></i>',
    'excursion-categories': '<i class="ri-folders-fill text-action"></i>',
    'transport-categories': '<i class="ri-list-settings-fill text-action"></i>'
};

const title = collectionNames[collection] || collection;
const icon = collectionIcons[collection] || '<i class="ri-folder-fill"></i>';

const items = await getCollection(`${collection}.json`);
const isArray = Array.isArray(items);
const activeCount = isArray ? items.filter(i => i.isActive).length : 0;

// Группировка для транспорта
let groupedItems = null;

const transportTitlesMap = {
    'standard': 'Стандарт',
    'comfort': 'Комфорт',
    'maxi': 'Макси-скутеры',
    'moto': 'Мотоциклы',
    'car': 'Автомобили'
};

if (collection === 'transport-items' && isArray) {
    const categories = await getCollection('transport-categories.json');
    groupedItems = categories.map(cat => ({
        ...cat,
        title: transportTitlesMap[cat.slug] || cat.title,
        items: items.filter(i => i.categoryId === cat.id)
    }));
    // Добавляем байки без категорий, если есть
    const uncategorizedItems = items.filter(i => !i.categoryId || !categories.find(c => c.id === i.categoryId));
    if (uncategorizedItems.length > 0) {
        groupedItems.push({
            id: 'uncategorized',
            title: 'Без категории',
            items: uncategorizedItems
        });
    }
}

// Группировка для экскурсий
if (collection === 'excursions' && isArray) {
    const categories = await getCollection('excursion-categories.json');
    groupedItems = categories.map(cat => ({
        ...cat,
        items: items.filter(i => i.categoryId === cat.id)
    }));
    const uncategorizedItems = items.filter(i => !i.categoryId || !categories.find(c => c.id === i.categoryId));
    if (uncategorizedItems.length > 0) {
        groupedItems.push({
            id: 'uncategorized',
            title: 'Без категории',
            items: uncategorizedItems
        });
    }
}

if (!isArray) {
    return Astro.redirect(`/admin/${collection}/edit`);
}
---

<AdminLayout title={title}>
    <div class="animate-in fade-in slide-in-from-bottom-4 duration-700">
        <!-- Header Section -->
        <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4 mb-8">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 rounded-xl bg-white shadow-sm border border-slate-100 flex items-center justify-center text-2xl" set:html={icon}></div>
                <div>
                    <h1 class="text-2xl font-extrabold text-dark tracking-tight uppercase leading-none">{title}</h1>
                    {isArray && (
                        <div class="flex items-center gap-2 mt-1">
                            <span class="text-[9px] font-bold text-slate-400">Всего: {items.length}</span>
                            <span class="text-[9px] font-bold text-emerald-500">Активных: {activeCount}</span>
                        </div>
                    )}
                </div>
            </div>
            
            <div class="flex items-center gap-3 flex-wrap">
                <!-- Size Switcher -->
                {isArray && items.length > 0 && (
                    <div class="flex items-center gap-1 bg-slate-100 rounded-lg p-1">
                        <button data-size="small" class="size-btn px-3 py-1.5 rounded-md text-xs font-bold transition-all text-slate-400 hover:text-slate-600" title="5 в ряд">
                            S
                        </button>
                        <button data-size="medium" class="size-btn px-3 py-1.5 rounded-md text-xs font-bold transition-all text-slate-400 hover:text-slate-600" title="4 в ряд">
                            M
                        </button>
                        <button data-size="large" class="size-btn px-3 py-1.5 rounded-md text-xs font-bold transition-all bg-white text-action shadow-sm" title="3 в ряд">
                            L
                        </button>
                    </div>
                )}
                
                {isArray && (
                    <a href={`/admin/${collection}/create`} class="group flex items-center gap-2 bg-action hover:bg-action-hover text-white px-5 py-2.5 rounded-xl text-[10px] font-black uppercase tracking-widest shadow-lg transition-all hover:-translate-y-0.5">
                        <i class="ri-add-line text-base"></i>
                        <span>Добавить</span>
                    </a>
                )}
            </div>
        </div>

        <!-- Filters and Search -->
        {isArray && items.length > 0 && (
            <div class="mb-10 flex flex-col lg:flex-row gap-4">
                <div class="relative flex-1 group">
                    <span class="absolute left-5 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-action transition-colors">
                        <i class="ri-search-2-line text-xl"></i>
                    </span>
                    <input 
                        type="text" 
                        id="searchInput" 
                        placeholder="Поиск по названию..." 
                        class="w-full px-6 py-4 pl-14 bg-white border border-slate-200 rounded-2xl focus:outline-none focus:ring-4 focus:ring-action/5 focus:border-action transition-all font-bold text-dark shadow-sm"
                    />
                </div>
                <div class="flex p-1.5 bg-slate-100 rounded-2xl gap-1 border border-slate-200 shadow-inner">
                    <button data-filter="all" class="filter-btn active flex items-center gap-2 px-6 py-3 text-[10px] font-black uppercase tracking-widest rounded-xl bg-white text-dark shadow-sm transition-all">
                        <i class="ri-layout-grid-fill text-action"></i> Все
                    </button>
                    <button data-filter="active" class="filter-btn flex items-center gap-2 px-6 py-3 text-[10px] font-black uppercase tracking-widest rounded-xl text-slate-500 hover:text-dark transition-all">
                        <i class="ri-checkbox-circle-fill"></i> Активные
                    </button>
                    <button data-filter="hidden" class="filter-btn flex items-center gap-2 px-6 py-3 text-[10px] font-black uppercase tracking-widest rounded-xl text-slate-500 hover:text-dark transition-all">
                        <i class="ri-eye-off-fill"></i> Скрытые
                    </button>
                </div>
            </div>
        )}

        <!-- Content Section -->
        {!isArray ? (
            <div class="bg-white p-16 rounded-[2.5rem] shadow-xl shadow-slate-200/50 border border-slate-100 text-center relative overflow-hidden group">
                <div class="absolute top-0 right-0 p-8 opacity-[0.03] grayscale pointer-events-none group-hover:scale-110 transition-transform duration-1000">
                    <span class="text-[12rem] leading-none">⚙️</span>
                </div>
                <div class="w-24 h-24 bg-slate-50 rounded-3xl flex items-center justify-center mx-auto mb-8 border border-slate-100 shadow-inner">
                    <span class="text-5xl">⚙️</span>
                </div>
                <h2 class="text-3xl font-black text-dark mb-4 tracking-tight uppercase">Настройки сайта</h2>
                <p class="text-slate-500 mb-10 max-w-md mx-auto font-medium">Редактируйте общие настройки, контактную информацию и конфигурацию вашего ресурса.</p>
                <a href={`/admin/${collection}/edit`} class="inline-flex items-center gap-3 bg-dark hover:bg-black text-white px-10 py-5 rounded-2xl text-[10px] font-black uppercase tracking-[0.2em] shadow-xl transition-all hover:-translate-y-1 active:scale-95">
                    <i class="ri-edit-2-fill text-lg"></i>
                    Редактировать всё
                </a>
            </div>
        ) : (
            <>
                {items.length === 0 ? (
                    <div class="bg-white p-20 rounded-[2.5rem] shadow-sm border border-slate-100 text-center">
                        <div class="w-20 h-20 bg-slate-50 rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-inner">
                            <span class="text-3xl text-slate-300 italic block -rotate-12">Empty</span>
                        </div>
                        <p class="text-slate-400 font-black text-[10px] uppercase tracking-[0.3em]">Каталог пока пуст</p>
                        <p class="text-slate-500 text-xl font-bold mt-4">Добавьте свой первый элемент, чтобы начать</p>
                    </div>
                ) : (
                    <div id="content-areas">
                        {(collection === 'transport-items' || collection === 'excursions') && groupedItems ? (
                            groupedItems.map((group) => {
                                if (group.items.length === 0) return null;
                                return (
                                    <div class="category-group mb-12 last:mb-0">
                                        <div class="flex items-center gap-4 mb-6 py-4 transition-all">
                                            <div class="h-px flex-1 bg-slate-200"></div>
                                            <h2 class="text-xs font-black text-slate-400 uppercase tracking-[0.3em] flex items-center gap-2">
                                                <i class="ri-folder-open-fill text-action"></i>
                                                {group.title}
                                                <span class="bg-slate-100 text-slate-500 px-2 py-0.5 rounded text-[9px]">{group.items.length}</span>
                                            </h2>
                                            <div class="h-px flex-1 bg-slate-200"></div>
                                        </div>
                                        
                                        <div class="sortable-list grid gap-4" data-group-id={group.id} style="grid-template-columns: repeat(auto-fill, minmax(var(--card-min-width, 320px), 1fr));">
                                            {group.items.map((item) => (
                                                <div class="item-row bg-white rounded-2xl shadow-sm border border-slate-200/60 overflow-hidden group hover:shadow-xl hover:border-action/20 transition-all duration-300 flex flex-col" 
                                                    data-id={item.id} 
                                                    data-title={(item.title || item.name || '').toLowerCase()}
                                                    data-active={String(item.isActive !== false)}
                                                    data-popular={String(item.isPopular === true)}>
                                                    
                                                    <div class="handle cursor-grab active:cursor-grabbing bg-slate-50/50 border-b border-slate-100 px-6 py-3 flex items-center justify-between">
                                                        <div class="flex items-center gap-2 text-slate-300 group-hover:text-slate-400 transition-colors">
                                                            <i class="ri-draggable text-xl"></i>
                                                            <span class="text-[9px] font-black uppercase tracking-[0.2em]">Упорядочить</span>
                                                        </div>
                                                        <span class={`text-[8px] font-black uppercase tracking-[0.2em] px-3 py-1.5 rounded-full border shadow-sm ${item.isActive !== false ? 'bg-emerald-50 text-emerald-600 border-emerald-100' : 'bg-rose-50 text-rose-500 border-rose-100'}`}>
                                                            {item.isActive !== false ? 'Активен' : 'Скрыт'}
                                                        </span>
                                                    </div>
                                                    
                                                    <a href={`/admin/${collection}/${item.id}`} class="relative overflow-hidden aspect-card bg-slate-100 block group/edit">
                                                        {item.image ? (
                                                            <img src={item.image} alt="" class="w-full h-full object-cover group-hover/edit:scale-110 transition-transform duration-1000" loading="lazy" />
                                                        ) : (
                                                            <div class="w-full h-full flex items-center justify-center opacity-20 text-slate-400 text-6xl">
                                                                <i class="ri-image-2-line"></i>
                                                            </div>
                                                        )}
                                                        
                                                        <div class="absolute inset-0 bg-dark/90 opacity-0 group-hover/edit:opacity-100 transition-opacity flex items-center justify-center">
                                                            <div class="flex flex-col items-center gap-2 text-white">
                                                                <i class="ri-edit-2-fill text-4xl"></i>
                                                                <span class="text-[10px] font-black uppercase tracking-[.3em]">Редактировать</span>
                                                            </div>
                                                        </div>
                                                        
                                                        {item.isPopular === true && (
                                                            <div class="absolute top-4 right-4 bg-amber-400 text-white px-3 py-1.5 rounded-xl shadow-lg flex items-center gap-1.5 animate-pulse z-10">
                                                                <i class="ri-star-fill text-[10px]"></i>
                                                                <span class="text-[8px] font-black uppercase tracking-widest">TOP</span>
                                                            </div>
                                                        )}
                                                    </a>
                                                    
                                                    <div class="p-4 flex flex-col flex-1">
                                                        <h3 class="font-bold text-base text-dark group-hover:text-action transition-colors line-clamp-2 leading-snug mb-3">
                                                            {item.title || item.name || 'Без названия'}
                                                        </h3>
                                                        
                                                        <div class="flex items-center gap-2 flex-wrap">
                                                            <button 
                                                                onclick={`toggleStatus(event, '${item.id}', 'isActive', ${item.isActive !== false})`}
                                                                class={item.isActive !== false 
                                                                    ? 'px-4 py-2 rounded-full text-[9px] font-black uppercase tracking-wider transition-all shadow-sm bg-emerald-100 text-emerald-700 border border-emerald-200 hover:bg-emerald-200' 
                                                                    : 'px-4 py-2 rounded-full text-[9px] font-black uppercase tracking-wider transition-all shadow-sm bg-slate-100 text-slate-400 border border-slate-200 hover:bg-slate-200'}
                                                            >
                                                                {item.isActive !== false ? '✓ Активен' : '× Скрыт'}
                                                            </button>
                                                            
                                                            <button 
                                                                onclick={`toggleStatus(event, '${item.id}', 'isPopular', ${item.isPopular === true})`}
                                                                class={item.isPopular === true 
                                                                    ? 'px-4 py-2 rounded-full text-[9px] font-black uppercase tracking-wider transition-all shadow-sm bg-amber-100 text-amber-700 border border-amber-200 hover:bg-amber-200' 
                                                                    : 'px-4 py-2 rounded-full text-[9px] font-black uppercase tracking-wider transition-all shadow-sm bg-slate-100 text-slate-400 border border-slate-200 hover:bg-slate-200'}
                                                            >
                                                                {item.isPopular === true ? '★ Популярное' : '☆'}
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                );
                            })
                        ) : (
                            <div id="sortable-list" class="sortable-list grid gap-4" style="grid-template-columns: repeat(auto-fill, minmax(var(--card-min-width, 320px), 1fr));">
                                {items.map((item) => (
                                    <div class="item-row bg-white rounded-2xl shadow-sm border border-slate-200/60 overflow-hidden group hover:shadow-xl hover:border-action/20 transition-all duration-300 flex flex-col" 
                                        data-id={item.id} 
                                        data-title={(item.title || item.name || '').toLowerCase()}
                                        data-active={String(item.isActive !== false)}
                                        data-popular={String(item.isPopular === true)}>
                                        
                                        <div class="handle cursor-grab active:cursor-grabbing bg-slate-50/50 border-b border-slate-100 px-6 py-3 flex items-center justify-between">
                                            <div class="flex items-center gap-2 text-slate-300 group-hover:text-slate-400 transition-colors">
                                                <i class="ri-draggable text-xl"></i>
                                                <span class="text-[9px] font-black uppercase tracking-[0.2em]">Упорядочить</span>
                                            </div>
                                            <span class={`text-[8px] font-black uppercase tracking-[0.2em] px-3 py-1.5 rounded-full border shadow-sm ${item.isActive !== false ? 'bg-emerald-50 text-emerald-600 border-emerald-100' : 'bg-rose-50 text-rose-500 border-rose-100'}`}>
                                                {item.isActive !== false ? 'Активен' : 'Скрыт'}
                                            </span>
                                        </div>
                                        
                                        <a href={`/admin/${collection}/${item.id}`} class="relative overflow-hidden aspect-card bg-slate-100 block group/edit">
                                            {item.image ? (
                                                <img src={item.image} alt="" class="w-full h-full object-cover group-hover/edit:scale-110 transition-transform duration-1000" loading="lazy" />
                                            ) : (
                                                <div class="w-full h-full flex items-center justify-center opacity-20 text-slate-400 text-6xl">
                                                    <i class="ri-image-2-line"></i>
                                                </div>
                                            )}
                                            
                                            <div class="absolute inset-0 bg-dark/90 opacity-0 group-hover/edit:opacity-100 transition-opacity flex items-center justify-center">
                                                <div class="flex flex-col items-center gap-2 text-white">
                                                    <i class="ri-edit-2-fill text-4xl"></i>
                                                    <span class="text-[10px] font-black uppercase tracking-[.3em]">Редактировать</span>
                                                </div>
                                            </div>
                                            
                                            {item.isPopular === true && (
                                                <div class="absolute top-4 right-4 bg-amber-400 text-white px-3 py-1.5 rounded-xl shadow-lg flex items-center gap-1.5 animate-pulse z-10">
                                                    <i class="ri-star-fill text-[10px]"></i>
                                                    <span class="text-[8px] font-black uppercase tracking-widest">TOP</span>
                                                </div>
                                            )}
                                        </a>
                                        
                                        <div class="p-4 flex flex-col flex-1">
                                            <h3 class="font-bold text-base text-dark group-hover:text-action transition-colors line-clamp-2 leading-snug mb-3">
                                                {item.title || item.name || 'Без названия'}
                                            </h3>
                                            
                                            <div class="flex items-center gap-2 flex-wrap">
                                                <button 
                                                    onclick={`toggleStatus(event, '${item.id}', 'isActive', ${item.isActive !== false})`}
                                                    class={item.isActive !== false 
                                                        ? 'px-4 py-2 rounded-full text-[9px] font-black uppercase tracking-wider transition-all shadow-sm bg-emerald-100 text-emerald-700 border border-emerald-200 hover:bg-emerald-200' 
                                                        : 'px-4 py-2 rounded-full text-[9px] font-black uppercase tracking-wider transition-all shadow-sm bg-slate-100 text-slate-400 border border-slate-200 hover:bg-slate-200'}
                                                >
                                                    {item.isActive !== false ? '✓ Активен' : '× Скрыт'}
                                                </button>
                                                
                                                <button 
                                                    onclick={`toggleStatus(event, '${item.id}', 'isPopular', ${item.isPopular === true})`}
                                                    class={item.isPopular === true 
                                                        ? 'px-4 py-2 rounded-full text-[9px] font-black uppercase tracking-wider transition-all shadow-sm bg-amber-100 text-amber-700 border border-amber-200 hover:bg-amber-200' 
                                                        : 'px-4 py-2 rounded-full text-[9px] font-black uppercase tracking-wider transition-all shadow-sm bg-slate-100 text-slate-400 border border-slate-200 hover:bg-slate-200'}
                                                >
                                                    {item.isPopular === true ? '★ Популярное' : '☆'}
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                )}
            </>
        )}
    </div>

    <div id="toast" class="fixed bottom-6 right-6 transform translate-y-20 opacity-0 transition-all duration-300 z-50">
        <div class="bg-dark text-white px-6 py-4 rounded-xl shadow-2xl flex items-center gap-3">
            <span id="toast-icon">✓</span>
            <span id="toast-message" class="font-semibold">Сохранено</span>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script define:vars={{ collection }}>
        // Size Switcher Logic
        const cardSizes = {
            small: '200px',   // 5 in row
            medium: '280px',  // 4 in row
            large: '380px'    // 3 in row
        };
        
        function setCardSize(size) {
            const grids = document.querySelectorAll('.sortable-list');
            grids.forEach(grid => {
                grid.style.setProperty('--card-min-width', cardSizes[size]);
            });
            
            // Update button states
            document.querySelectorAll('.size-btn').forEach(btn => {
                btn.classList.remove('bg-white', 'text-action', 'shadow-sm');
                btn.classList.add('text-slate-400');
                if (btn.dataset.size === size) {
                    btn.classList.add('bg-white', 'text-action', 'shadow-sm');
                    btn.classList.remove('text-slate-400');
                }
            });
            
            localStorage.setItem('admin-card-size', size);
        }
        
        // Initialize size switcher
        document.querySelectorAll('.size-btn').forEach(btn => {
            btn.addEventListener('click', () => setCardSize(btn.dataset.size));
        });
        
        // Load saved size
        const savedSize = localStorage.getItem('admin-card-size');
        if (savedSize && cardSizes[savedSize]) {
            setCardSize(savedSize);
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toast-icon');
            const msg = document.getElementById('toast-message');
            
            icon.textContent = type === 'success' ? '✓' : '✗';
            msg.textContent = message;
            
            toast.classList.remove('translate-y-20', 'opacity-0');
            toast.classList.add('translate-y-0', 'opacity-100');
            
            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
                toast.classList.remove('translate-y-0', 'opacity-100');
            }, 3000);
        }

        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('searchInput');
            const filterBtns = document.querySelectorAll('.filter-btn');
            const rows = document.querySelectorAll('.item-row');
            
            let currentFilter = 'all';

            function applyFilters() {
                const searchTerm = (searchInput?.value || '').toLowerCase();
                
                rows.forEach(row => {
                    const title = row.dataset.title || '';
                    const isActive = row.dataset.active === 'true';
                    
                    const matchesSearch = title.includes(searchTerm);
                    const matchesFilter = currentFilter === 'all' || 
                        (currentFilter === 'active' && isActive) ||
                        (currentFilter === 'hidden' && !isActive);
                    
                    row.style.display = matchesSearch && matchesFilter ? '' : 'none';
                });

                // Скрываем пустые группы
                document.querySelectorAll('.category-group').forEach(group => {
                    const visibleRows = group.querySelectorAll('.item-row:not([style*="display: none"])');
                    group.style.display = visibleRows.length > 0 ? '' : 'none';
                });
            }

            searchInput?.addEventListener('input', applyFilters);

            filterBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    filterBtns.forEach(b => {
                        b.classList.remove('active', 'bg-white', 'text-dark', 'shadow-sm');
                        b.classList.add('text-slate-500');
                    });
                    btn.classList.add('active', 'bg-white', 'text-dark', 'shadow-sm');
                    btn.classList.remove('text-slate-500');
                    currentFilter = btn.dataset.filter;
                    applyFilters();
                });
            });

            const lists = document.querySelectorAll('.sortable-list');
            lists.forEach(list => {
                if (list && list.querySelectorAll('.item-row').length > 0 && typeof Sortable !== 'undefined') {
                    new Sortable(list, {
                        handle: '.handle',
                        animation: 150,
                        ghostClass: 'bg-orange-50',
                        onEnd: async function () {
                            const allLists = document.querySelectorAll('.sortable-list');
                            const allItemIds = Array.from(allLists).flatMap(l => 
                                Array.from(l.querySelectorAll('.item-row')).map(row => row.getAttribute('data-id'))
                            );
                            
                            try {
                                const res = await fetch(`/api/${collection}/reorder`, {
                                    method: 'PUT',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ order: allItemIds })
                                });
                                if (!res.ok) throw new Error('Failed to save order');
                                showToast('Порядок сохранён');
                            } catch (err) {
                                console.error(err);
                                showToast('Ошибка сохранения', 'error');
                            }
                        },
                    });
                }
            });

            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const id = e.currentTarget.getAttribute('data-id');
                    const title = e.currentTarget.getAttribute('data-title');
                    const confirmed = await showConfirm(`Вы точно хотите удалить "${title}"?\n\nЭто действие НЕОБРАТИМО!`, '⚠️ Удаление');
                    if (!confirmed) return;

                    try {
                        const res = await fetch(`/api/${collection}/${id}`, { method: 'DELETE' });
                        if (res.ok) {
                            const row = e.currentTarget.closest('.item-row');
                            row.style.opacity = '0';
                            row.style.transform = 'scale(0.9)';
                            setTimeout(() => {
                                row.remove();
                                showToast('Элемент удалён');
                            }, 200);
                        } else {
                            showToast('Ошибка удаления', 'error');
                        }
                    } catch (err) {
                        console.error(err);
                        showToast('Ошибка сети', 'error');
                    }
                });
            });
            
            // Toggle Status Function
            window.toggleStatus = async function(event, itemId, field, currentValue) {
                event.preventDefault();
                event.stopPropagation();
                
                const button = event.target.closest('button');
                const originalHTML = button.innerHTML;
                button.disabled = true;
                button.innerHTML = '<i class="ri-loader-4-line animate-spin"></i>';
                
                try {
                    // Fetch full item first
                    const getRes = await fetch(`/api/${collection}/${itemId}`);
                    if (!getRes.ok) throw new Error('Failed to fetch item');
                    const item = await getRes.json();
                    
                    // Update the field
                    item[field] = !currentValue;
                    
                    // Save updated item
                    const res = await fetch(`/api/${collection}/${itemId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(item)
                    });
                    
                    if (!res.ok) throw new Error('Failed to update');
                    
                    // Reload to reflect changes
                    location.reload();
                } catch (err) {
                    console.error(err);
                    showToast('Ошибка обновления', 'error');
                    button.innerHTML = originalHTML;
                    button.disabled = false;
                }
            };
        });
    </script>
</AdminLayout>
