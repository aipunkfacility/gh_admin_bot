
---
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { schemas } from '../../../lib/schemas';
import { getItem } from '../../../lib/data-store';

const { collection, id } = Astro.params;
const isCreate = !id || id === 'create';

// Redirect if schema not found
const schema = schemas[collection];
if (!schema) {
    return Astro.redirect('/admin');
}

let item = {};
if (!isCreate) {
    item = await getItem(`${collection}.json`, id);
    if (!item) {
        return Astro.redirect(`/admin/${collection}`);
    }
} else {
    // Default values
    schema.fields.forEach(f => {
        if (f.default !== undefined) item[f.name] = f.default;
    });
}

// Helper to get nested value (e.g. contacts.telegram)
const getValue = (obj, path) => {
    return path.split('.').reduce((acc, part) => acc && acc[part], obj);
};

// Helper to normalize image paths for preview
const normalizeSrc = (src) => {
    if (!src) return '';
    if (src.startsWith('http') || src.startsWith('/')) return src;
    if (src.startsWith('./')) return src.replace('./', '/');
    return '/' + src;
};
---

<AdminLayout title={isCreate ? '–°–æ–∑–¥–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞' : '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ'}>
    <div class="max-w-4xl mx-auto">
        <div class="flex items-center justify-between mb-8">
            <div>
                <h1 class="text-3xl font-extrabold text-dark tracking-tight uppercase">
                    {isCreate ? '–ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å' : '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ'}
                </h1>
                <div class="h-1 w-12 bg-primary mt-1"></div>
            </div>
            <a href={`/admin/${collection}`} class="text-[10px] font-black uppercase tracking-widest text-slate-400 hover:text-primary transition-colors flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É
            </a>
        </div>

        <form id="editForm" class="bg-white p-10 rounded-2xl shadow-sm border border-slate-200 space-y-8 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-primary to-orange-400"></div>
            
            <div class="grid grid-cols-1 gap-8">
                {schema.fields.map(field => (
                    <div class="space-y-2">
                        {field.type !== 'checkbox' && (
                        <label class="block text-[10px] font-black text-slate-500 uppercase tracking-widest ml-1">
                            {field.label} {field.required && <span class="text-primary">*</span>}
                        </label>
                        )}
                        
                        {field.type === 'text' && (
                            <input type="text" name={field.name} value={getValue(item, field.name) || ''} required={field.required}
                                class="w-full px-5 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all font-semibold text-dark" />
                        )}

                        {field.type === 'textarea' && (
                            <textarea name={field.name} rows={field.rows || 4} required={field.required}
                                class="w-full px-5 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all font-semibold text-dark">{getValue(item, field.name) || ''}</textarea>
                        )}

                        {field.type === 'number' && (
                            <input type="number" name={field.name} value={getValue(item, field.name) || ''} required={field.required}
                                class="w-full px-5 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all font-semibold text-dark" />
                        )}

                        {field.type === 'checkbox' && (
                            <div class="flex items-center gap-3 bg-slate-50 p-4 rounded-xl border border-slate-100">
                                <input type="checkbox" name={field.name} checked={!!getValue(item, field.name)}
                                    class="h-5 w-5 text-primary focus:ring-primary/20 border-slate-300 rounded-lg cursor-pointer" />
                                <span class="text-xs font-bold text-slate-600 uppercase tracking-wider">{field.label}</span>
                            </div>
                        )}
                        
{field.type === 'select' && (
                              <select name={field.name} class="w-full px-5 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all font-semibold text-dark">
                                  <option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>
                                  {field.options && field.options.map(opt => {
                                      const optValue = typeof opt === 'object' ? opt.value : opt;
                                      const optLabel = typeof opt === 'object' ? opt.label : opt;
                                      return (
                                          <option value={optValue} selected={getValue(item, field.name) === optValue}>{optLabel}</option>
                                      );
                                  })}
                              </select>
                          )}
                          
                          {field.type === 'array' && (
                              <textarea name={field.name} rows={field.rows || 4} data-type="array"
                                  class="w-full px-5 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all font-semibold text-dark"
                                  placeholder="–ö–∞–∂–¥—ã–π —ç–ª–µ–º–µ–Ω—Ç —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏">{(getValue(item, field.name) || []).join('\n')}</textarea>
                          )}
                          
                          {field.type === 'offices' && (
                              <div class="offices-editor space-y-4" data-name={field.name} data-initial={JSON.stringify(getValue(item, field.name) || [])}>
                                  <div class="offices-list space-y-3"></div>
                                  <button type="button" class="add-office-btn px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-600 text-xs font-bold uppercase tracking-wider rounded-lg transition-colors">
                                      + –î–æ–±–∞–≤–∏—Ç—å –æ—Ñ–∏—Å
                                  </button>
                              </div>
                          )}

                        {field.type === 'image' && (
                            <div class="space-y-4">
                                <div class="flex items-start gap-4">
                                    <input type="text" name={field.name} value={getValue(item, field.name) || ''} 
                                        class="image-path-input flex-1 px-5 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all font-semibold text-dark" 
                                        placeholder="/images/example.jpg" />
                                    <button type="button" class="upload-trigger-btn h-[52px] px-6 rounded-xl bg-dark text-white text-[10px] font-black uppercase tracking-widest hover:bg-slate-800 transition-all flex items-center justify-center gap-2 whitespace-nowrap">
                                        <span>üì∑ –ó–∞–≥—Ä—É–∑–∏—Ç—å</span>
                                    </button>
                                </div>
                            </div>
                        )}
                        
                        {field.help && field.type !== 'checkbox' && <p class="text-[10px] font-bold text-slate-400 mt-1 uppercase tracking-widest ml-1">{field.help}</p>}
                    </div>
                ))}
            </div>

            <div class="pt-10 border-t border-slate-100 flex items-center justify-between gap-4">
                {!isCreate && collection !== 'site-meta' && (
                    <div class="flex items-center gap-4">
                        <div class="flex flex-col gap-1">
                            <button type="button" id="deleteBtn" class="flex items-center justify-center gap-2 px-8 py-4 bg-rose-500 hover:bg-rose-600 text-white text-[10px] font-black uppercase tracking-widest rounded-xl transition-all">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                –£–¥–∞–ª–∏—Ç—å –Ω–∞–≤—Å–µ–≥–¥–∞
                            </button>
                            <p class="text-[9px] text-rose-400 font-semibold text-center">–£–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ</p>
                        </div>
                        
                        {/* Sync TG Button - —Ç–æ–ª—å–∫–æ –¥–ª—è excursions, transport-items, accommodations */}
                        {(collection === 'excursions' || collection === 'transport-items' || collection === 'accommodations') && (
                            <div class="flex flex-col gap-1">
                                <button type="button" id="syncTgBtn" class="flex items-center justify-center gap-2 px-8 py-4 bg-blue-500 hover:bg-blue-600 text-white text-[10px] font-black uppercase tracking-widest rounded-xl transition-all">
                                    <i class="ri-telegram-fill text-lg"></i>
                                    Sync TG
                                </button>
                                <p class="text-[9px] text-blue-400 font-semibold text-center">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –≤ –∫–∞–Ω–∞–ª</p>
                            </div>
                        )}
                    </div>
                )}
                <div class="flex gap-4 ml-auto">
                    <a href={`/admin/${collection}`} class="px-8 py-4 text-[10px] font-black uppercase tracking-widest text-slate-400 hover:text-dark transition-colors">–û—Ç–º–µ–Ω–∞</a>
                    <button type="submit" class="px-10 py-4 bg-primary hover:bg-primary-hover text-white text-[10px] font-black uppercase tracking-widest rounded-xl shadow-xl shadow-orange-500/20 transition-all active:scale-[98%]">
                        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                    </button>
                </div>
            </div>
        </form>
    </div>

    <script define:vars={{ collection, id, isCreate }}>
        const form = document.getElementById('editForm');
        
        // Delete functionality
        const deleteBtn = document.getElementById('deleteBtn');
        if (deleteBtn) {
            deleteBtn.addEventListener('click', async () => {
                const confirmed = await showConfirm('–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –ù–ï–û–ë–†–ê–¢–ò–ú–û!\n\n–í—ã —Ç–æ—á–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å?', '‚ö†Ô∏è –£–¥–∞–ª–µ–Ω–∏–µ');
                if (!confirmed) return;
                try {
                    const res = await fetch(`/api/${collection}/${id}`, { method: 'DELETE' });
                    if (res.ok) {
                        showToast('–ó–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞', 'success');
                        setTimeout(() => window.location.href = `/admin/${collection}`, 1000);
                    } else {
                        showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏', 'error');
                    }
                } catch (e) {
                    showToast('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error');
                }
            });
        }
        
        // Sync TG functionality
        const syncTgBtn = document.getElementById('syncTgBtn');
        if (syncTgBtn) {
            syncTgBtn.addEventListener('click', async () => {
                const confirmed = await showConfirm('–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å/–æ–±–Ω–æ–≤–∏—Ç—å —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä –≤ Telegram –∫–∞–Ω–∞–ª–µ?', 'üì¢ Telegram');
                if (!confirmed) return;
                
                const originalText = syncTgBtn.innerHTML;
                syncTgBtn.innerHTML = '<i class="ri-loader-4-line animate-spin"></i> –û—Ç–ø—Ä–∞–≤–∫–∞...';
                syncTgBtn.disabled = true;
                
                try {
                    const res = await fetch(`/api/bot/sync-channel`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ collection, id })
                    });
                    
                    const result = await res.json();
                    
                    if (res.ok) {
                        showToast('–£—Å–ø–µ—à–Ω–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ –≤ Telegram!', 'success');
                        setTimeout(() => location.reload(), 1500);
                    } else {
                        showToast('–û—à–∏–±–∫–∞: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
                    }
                } catch (e) {
                    console.error(e);
                    showToast('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏', 'error');
                } finally {
                    syncTgBtn.innerHTML = originalText;
                    syncTgBtn.disabled = false;
                }
            });
        }
        
        // Improved Image Upload Logic
        const normalizeSrc = (src) => {
            if (!src) return '';
            if (src.startsWith('http') || src.startsWith('/')) return src;
            if (src.startsWith('./')) return src.replace('./', '/');
            return '/' + src;
        };

        document.querySelectorAll('.image-path-input').forEach(input => {
            input.addEventListener('input', (e) => {
                const parent = input.closest('.space-y-4');
                const preview = parent.querySelector('.preview-container');
                const img = preview.querySelector('img');
                if (e.target.value) {
                    img.src = normalizeSrc(e.target.value);
                    preview.style.display = 'block';
                } else {
                    preview.style.display = 'none';
                }
            });
        });

        document.querySelectorAll('.upload-trigger-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const parentDiv = btn.closest('.space-y-4');
                const textInput = parentDiv.querySelector('input[type="text"]');
                const previewContainer = parentDiv.querySelector('.preview-container');
                const imgPreview = previewContainer.querySelector('img');
                
                // Create hidden file input
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = 'image/*';
                fileInput.style.display = 'none';
                document.body.appendChild(fileInput);
                
                fileInput.click();
                
                fileInput.onchange = async () => {
                    const file = fileInput.files[0];
                    if (!file) return;
                    
                    const formData = new FormData();
                    formData.append('file', file);
                    
                    const originalText = btn.innerHTML;
                    btn.innerHTML = '<span>‚è≥...</span>';
                    btn.disabled = true;
                    
                    try {
                        const res = await fetch('/api/upload', {
                            method: 'POST',
                            body: formData
                        });
                        const data = await res.json();
                        
                        if (data.success) {
                            textInput.value = data.url;
                            imgPreview.src = normalizeSrc(data.url);
                            previewContainer.style.display = 'block';
                        } else {
                            alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                        }
                    } catch (e) {
                        console.error(e);
                        alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ');
                    } finally {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                        document.body.removeChild(fileInput);
                    }
                };
            });
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(form);
            const data = {};

            // Handle nested keys and checkboxes
            for (let [key, value] of formData.entries()) {
                if (key.includes('.')) {
                    const [parent, child] = key.split('.');
                    if (!data[parent]) data[parent] = {};
                    data[parent][child] = value;
                } else {
                    data[key] = value;
                }
            }

            // Handle checkboxes explicitly
            const checkboxes = form.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => {
                data[cb.name] = cb.checked;
            });
            
            // Handle array fields (textarea with data-type="array")
            form.querySelectorAll('textarea[data-type="array"]').forEach(ta => {
                const name = ta.name;
                const lines = ta.value.split('\n').map(l => l.trim()).filter(l => l);
                data[name] = lines;
            });
            
            // Handle offices editor
            document.querySelectorAll('.offices-editor').forEach(editor => {
                const fieldName = editor.dataset.name;
                const offices = [];
                editor.querySelectorAll('.office-item').forEach(item => {
                    offices.push({
                        name: item.querySelector('[data-field="name"]').value,
                        address: item.querySelector('[data-field="address"]').value,
                        mapLink: item.querySelector('[data-field="mapLink"]').value
                    });
                });
                // Set nested value for contacts.offices
                if (fieldName.includes('.')) {
                    const [parent, child] = fieldName.split('.');
                    if (!data[parent]) data[parent] = {};
                    data[parent][child] = offices;
                } else {
                    data[fieldName] = offices;
                }
            });
            
            if (!isCreate) {
                data.id = id;
            } else if (!data.id) {
                data.id = (data.slug || String(Date.now()));
            }

            try {
                const url = `/api/${collection}/${data.id}`; 
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (res.ok) {
                    showToast('–ó–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!', 'success');
                    setTimeout(() => window.location.href = `/admin/${collection}`, 1000);
                } else {
                    const errData = await res.json();
                    showToast('–û—à–∏–±–∫–∞: ' + (errData.error || '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ'), 'error');
                }
            } catch (err) {
                console.error(err);
                showToast('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error');
            }
        });
        
        // Initialize offices editors
        function createOfficeItem(office = {}) {
            const div = document.createElement('div');
            div.className = 'office-item p-4 bg-slate-50 rounded-xl border border-slate-200 space-y-3';
            div.innerHTML = `
                <div class="flex justify-between items-center">
                    <span class="text-xs font-bold text-slate-500 uppercase">–û—Ñ–∏—Å</span>
                    <button type="button" class="remove-office text-red-400 hover:text-red-600 text-xs font-bold">–£–¥–∞–ª–∏—Ç—å</button>
                </div>
                <input type="text" data-field="name" value="${office.name || ''}" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –æ—Ñ–∏—Å–∞" 
                    class="w-full px-4 py-2 bg-white border border-slate-200 rounded-lg text-sm font-semibold" />
                <input type="text" data-field="address" value="${office.address || ''}" placeholder="–ê–¥—Ä–µ—Å" 
                    class="w-full px-4 py-2 bg-white border border-slate-200 rounded-lg text-sm font-semibold" />
                <input type="text" data-field="mapLink" value="${office.mapLink || ''}" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞—Ä—Ç—É (Google Maps)" 
                    class="w-full px-4 py-2 bg-white border border-slate-200 rounded-lg text-sm font-semibold" />
            `;
            div.querySelector('.remove-office').onclick = () => div.remove();
            return div;
        }
        
        document.querySelectorAll('.offices-editor').forEach(editor => {
            const list = editor.querySelector('.offices-list');
            const addBtn = editor.querySelector('.add-office-btn');
            const initial = JSON.parse(editor.dataset.initial || '[]');
            
            initial.forEach(office => list.appendChild(createOfficeItem(office)));
            addBtn.onclick = () => list.appendChild(createOfficeItem());
        });
    </script>
</AdminLayout>
