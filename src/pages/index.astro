---
import MainLayout from '../layouts/MainLayout.astro';
import Hero from '../components/Hero.astro';
import Popular from '../sections/Popular.astro';
import Excursions from '../sections/Excursions.astro';
import Services from '../sections/Services.astro';
import Transport from '../sections/Transport.astro';
import Accommodations from '../sections/Accommodations.astro';
import Contacts from '../sections/Contacts.astro';
import CurrencyRates from '../sections/CurrencyRates.astro';

import { getCollection, getSiteMeta } from '../lib/data-store';
import type { Excursion, TransportItem, Accommodation, Service, Category } from '../lib/schemas';
// TransportCategory is effectively Category now




// Загрузка данных параллельно
const [
    siteMeta,
    excursionsRaw,
    transportRaw,
    accommodationsRaw,
    servicesRaw,
    allTransportCategories,
    sectionsRaw
] = await Promise.all([
    getSiteMeta(),
    getCollection('excursions.json'),
    getCollection('transport-items.json'),
    getCollection('accommodations.json'),
    getCollection('services.json'),
    getCollection('transport-categories.json'),
    getCollection('sections') // New Sections Table
]);

const siteMetaObj = (siteMeta || {}) as Record<string, unknown>;
const transportCategories = ((((allTransportCategories || []) as any[]).filter(c => c.isActive !== false)) as unknown as Category[]);

const excursions = (excursionsRaw || []) as Excursion[];
const transport = (transportRaw || []) as TransportItem[];
const accommodations = (accommodationsRaw || []) as Accommodation[];
const services = (servicesRaw || []) as Service[];

// Популярные элементы
const popularItems: Array<any> = [
    ...excursions.filter(i => i.isPopular && i.isActive !== false).map(i => ({...i, type: 'excursion'})),
    ...transport.filter(i => i.isPopular && i.isActive !== false).map(i => ({...i, type: 'transport'})),
    ...accommodations.filter(i => i.isPopular && i.isActive !== false).map(i => ({...i, type: 'accommodation'})),
    ...services.filter(i => i.isPopular && i.isActive !== false).map(i => ({...i, type: 'service'})),
];

const activeExcursions = excursions.filter(i => i.isActive !== false);
const activeTransport = transport.filter(i => i.isActive !== false);
const activeAccommodations = accommodations.filter(i => i.isActive !== false);
const activeServices = services.filter(i => i.isActive !== false);

const defaultSections: any[] = [
    { id: 'popular', isActive: true },
    { id: 'excursions', isActive: true },
    { id: 'transport', isActive: true },
    { id: 'accommodations', isActive: true },
    { id: 'services', isActive: true },
    { id: 'contacts', isActive: true },
];

// Use sections from DB or fallback
const sections = (sectionsRaw && (sectionsRaw as any[]).length > 0) 
    ? (sectionsRaw as any[]) 
    : defaultSections;
---

<MainLayout 
    title={(siteMetaObj.mainTitle as string) || "Green Hill Tours"} 
    description={(siteMetaObj.mainSubtitle as string) || "Экскурсии и аренда транспорта в Муйне"}
    sections={sections as any}
>
    <Hero 
        mainTitle={(siteMetaObj.mainTitle as string) || "Green Hill Tours"}
        mainSubtitle={(siteMetaObj.mainSubtitle as string) || "Лучшие экскурсии и аренда транспорта в Муйне"}
    />

    {sections.map((section) => {
        if (!section.isActive) return null;
        
        if (section.id === 'popular' && popularItems.length > 0) {
            return <Popular items={popularItems as any} categories={transportCategories} />;
        }
        if (section.id === 'excursions' && activeExcursions.length > 0) {
            return <Excursions excursions={activeExcursions} />;
        }
        if (section.id === 'transport' && activeTransport.length > 0) {
             {/* Category casting */}
            return <Transport categories={transportCategories} transportItems={activeTransport} />;
        }
        if (section.id === 'services' && activeServices.length > 0) {
            return <Services services={activeServices} />;
        }
        if (section.id === 'accommodations' && activeAccommodations.length > 0) {
            return <Accommodations accommodations={activeAccommodations} />;
        }
        if (section.id === 'contacts') {
            {/* SiteMeta casting */}
            return <Contacts siteMeta={siteMetaObj} />;
        }
        if (section.id === 'currency') {
            return <CurrencyRates />;
        }
        return null;
    })}

    <script is:inline>
        /**
         * WhatsApp и Аккордеон
         */
        function openWhatsApp(message = '') {
            const phone = '84123456789'; 
            window.open(`https://wa.me/${phone}?text=${encodeURIComponent(message)}`, '_blank');
        }

        function toggleServiceAccordion(element) {
            const isCurrentlyOpen = element.classList.contains('is-open');
            document.querySelectorAll('.service-card.is-open').forEach(card => card.classList.remove('is-open'));
            if (!isCurrentlyOpen) element.classList.add('is-open');
        }

        window.openWhatsApp = openWhatsApp;
        window.toggleServiceAccordion = toggleServiceAccordion;
    </script>
</MainLayout>