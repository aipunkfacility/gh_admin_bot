---
import AdminLayout from '../../layouts/AdminLayout.astro';
import { getCollection, getItem } from '../../lib/data-store';

export const prerender = false;

const cookies = Astro.cookies;
const ADMIN_PASSWORD = import.meta.env.ADMIN_PASSWORD;

let isAuth = false;
if (ADMIN_PASSWORD) {
    const { getAuthToken } = await import('../../lib/auth');
    const expectedToken = getAuthToken(ADMIN_PASSWORD);
    isAuth = cookies.get('gh_admin_auth')?.value === expectedToken;
}

if (!isAuth) {
    return Astro.redirect('/admin/login');
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–∫—É—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö
let rates = { rub_rate: 280, usdt_rate: 25500, usd_rate: 25000, eur_rate: 27000, cny_rate: 3500 };

try {
    const ratesData = await getCollection('rates');
    if (ratesData && !Array.isArray(ratesData)) {
         rates = ratesData as any;
    } else if (Array.isArray(ratesData) && ratesData.length > 0) {
        // Fallback –µ—Å–ª–∏ –≤–µ—Ä–Ω—É–ª—Å—è –º–∞—Å—Å–∏–≤
        const matched = (ratesData as any[]).reduce((acc, curr) => {
            acc[`${curr.id.toLowerCase()}_rate`] = curr.rate;
            return acc;
        }, {});
        rates = { ...rates, ...matched };
    }
} catch (error) {
    console.error('Error loading rates:', error);
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –∞–¥–º–∏–Ω–æ–≤ –∏–∑ .env (–º–∞—Å—Ç–µ—Ä-—Å–ø–∏—Å–æ–∫)
let envAdmins: number[] = [];
try {
    const adminIdsEnv = process.env.TELEGRAM_ADMIN_IDS || import.meta.env.TELEGRAM_ADMIN_IDS || '';
    envAdmins = adminIdsEnv.split(',').map(id => parseInt(id.trim())).filter(id => !isNaN(id));
} catch (e) {
    console.warn('Error parsing admins from env:', e);
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –∞–¥–º–∏–Ω–æ–≤ –∏–∑ –ë–î (–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫)
let dbAdmins: number[] = [];
try {
    const dbAdminsRaw = await getItem('site-meta', 'bot_admins');
    dbAdmins = Array.isArray(dbAdminsRaw) ? dbAdminsRaw : [];
} catch (e) {
    console.warn('Failed to fetch dynamic admins:', e.message);
}

const dbAdminIds = dbAdmins.map(id => parseInt(id as any)).filter(id => !isNaN(id));
const allAdmins = [...new Set([...envAdmins, ...dbAdminIds])];
---

<AdminLayout title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ë–æ—Ç–∞">
    <div class="space-y-6">
        <div class="flex flex-col gap-2">
            <h1 class="text-4xl font-black text-slate-900 tracking-tight flex items-center gap-3">
                <span class="text-action"><i class="ri-robot-2-fill"></i></span>
                –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Telegram –ë–æ—Ç–∞
            </h1>
            <p class="text-slate-500 text-lg font-medium">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—É—Ä—Å–∞–º–∏ –≤–∞–ª—é—Ç –∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º–∏</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

        <!-- –ö—É—Ä—Å—ã –í–∞–ª—é—Ç -->
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="bg-gradient-to-r from-emerald-600 to-emerald-700 px-8 py-6">
                <h2 class="text-2xl font-bold text-white flex items-center gap-3">
                    <i class="ri-money-dollar-circle-fill text-3xl"></i>
                    –ö—É—Ä—Å—ã –í–∞–ª—é—Ç
                </h2>
            </div>
            
            <form id="ratesForm" class="p-8 space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">üá∑üá∫ –†—É–±–ª—å (RUB) ‚Üí VND</label>
                        <input 
                            type="number" 
                            name="rub_rate" 
                            value={rates.rub_rate}
                            class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200 transition-all font-semibold text-lg"
                            required
                        />
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">üíé USDT ‚Üí VND</label>
                        <input 
                            type="number" 
                            name="usdt_rate" 
                            value={rates.usdt_rate}
                            class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200 transition-all font-semibold text-lg"
                            required
                        />
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">üíµ –î–æ–ª–ª–∞—Ä (USD) ‚Üí VND</label>
                        <input 
                            type="number" 
                            name="usd_rate" 
                            value={rates.usd_rate}
                            class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200 transition-all font-semibold text-lg"
                            required
                        />
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">üá™üá∫ –ï–≤—Ä–æ (EUR) ‚Üí VND</label>
                        <input 
                            type="number" 
                            name="eur_rate" 
                            value={rates.eur_rate}
                            class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200 transition-all font-semibold text-lg"
                            required
                        />
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">üá®üá≥ –Æ–∞–Ω—å (CNY) ‚Üí VND</label>
                        <input 
                            type="number" 
                            name="cny_rate" 
                            value={rates.cny_rate}
                            class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200 transition-all font-semibold text-lg"
                            required
                        />
                    </div>
                </div>
                
                <div class="flex justify-end">
                    <button 
                        type="submit" 
                        class="btn-primary px-8 py-3 rounded-xl font-bold text-lg shadow-lg hover:shadow-xl transition-all flex items-center gap-2"
                    >
                        <i class="ri-save-line"></i>
                        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ö—É—Ä—Å—ã
                    </button>
                </div>
            </form>
        </div>

        <!-- –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã -->
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="bg-gradient-to-r from-slate-600 to-slate-700 px-8 py-6">
                <h2 class="text-2xl font-bold text-white flex items-center gap-3">
                    <i class="ri-admin-fill text-3xl"></i>
                    –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –ë–æ—Ç–∞
                </h2>
            </div>
            
            <div class="p-8 space-y-6">
                <!-- Add Admin Form -->
                <form id="addAdminForm" class="flex gap-2">
                    <input 
                        type="number" 
                        id="newAdminId" 
                        placeholder="Telegram ID (–Ω–∞–ø—Ä–∏–º–µ—Ä: 12345678)" 
                        class="flex-1 px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-slate-500 transition-all font-semibold"
                        required
                    />
                    <button type="submit" class="bg-slate-800 text-white px-6 py-3 rounded-xl font-bold hover:bg-slate-900 transition-all">
                        –î–æ–±–∞–≤–∏—Ç—å
                    </button>
                </form>

                <div>
                    <h3 class="text-lg font-bold text-slate-800 mb-4">–°–ø–∏—Å–æ–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤:</h3>
                    <div class="space-y-3">
                        {allAdmins.map((adminId) => {
                            const isEnv = envAdmins.includes(adminId);
                            return (
                                <div class="flex items-center justify-between bg-slate-50 rounded-xl px-6 py-4 border border-slate-200 group">
                                    <div class="flex items-center gap-3">
                                        <span class="font-mono text-lg font-bold text-slate-800">{adminId}</span>
                                        {isEnv && (
                                            <span class="bg-amber-100 text-amber-700 text-[10px] font-black uppercase px-2 py-0.5 rounded border border-amber-200" title="–ù–∞—Å—Ç—Ä–æ–µ–Ω –≤ .env —Å–µ–∫—Ä–µ—Ç–∞—Ö">
                                                Master
                                            </span>
                                        )}
                                    </div>
                                    {!isEnv ? (
                                        <button 
                                            onclick={`removeAdmin(${adminId})`}
                                            class="text-rose-500 hover:text-rose-700 p-2 opacity-0 group-hover:opacity-100 transition-all"
                                            title="–£–¥–∞–ª–∏—Ç—å"
                                        >
                                            <i class="ri-delete-bin-line text-xl"></i>
                                        </button>
                                    ) : (
                                        <span class="text-slate-400 text-[10px] font-bold uppercase">Locked</span>
                                    )}
                                </div>
                            );
                        })}
                    </div>
                </div>
            </div>
        </div>
        </div>
    </div>

    <script is:inline define:vars={{ envAdmins, dbAdminIds }}>
        let currentDbAdmins = dbAdminIds;

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫—É—Ä—Å–æ–≤
        document.getElementById('ratesForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const rates = {
                rub_rate: parseInt(formData.get('rub_rate')),
                usdt_rate: parseInt(formData.get('usdt_rate')),
                usd_rate: parseInt(formData.get('usd_rate')),
                eur_rate: parseInt(formData.get('eur_rate')),
                cny_rate: parseInt(formData.get('cny_rate')),
            };
            
            try {
                const res = await fetch('/api/bot/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type: 'rates', payload: rates })
                });
                
                if (res.ok) {
                    showToast('‚úÖ –ö—É—Ä—Å—ã —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã!', 'success');
                } else {
                    showToast('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫—É—Ä—Å–æ–≤', 'error');
                }
            } catch (error) {
                console.error(error);
                showToast('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error');
            }
        });

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
        document.getElementById('addAdminForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const input = document.getElementById('newAdminId');
            const newId = parseInt(input.value);
            
            if (isNaN(newId)) return;

            if (envAdmins.includes(newId) || currentDbAdmins.includes(newId)) {
                showToast('‚ö†Ô∏è –≠—Ç–æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω', 'info');
                return;
            }
            
            currentDbAdmins.push(newId);
            await saveAdmins();
            input.value = '';
        });

        // –£–¥–∞–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
        window.removeAdmin = async (adminId) => {
            const confirmed = await showConfirm(`–£–¥–∞–ª–∏—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ ${adminId}?`, '–£–¥–∞–ª–µ–Ω–∏–µ');
            if (!confirmed) return;
            
            currentDbAdmins = currentDbAdmins.filter(id => id !== adminId);
            await saveAdmins();
        };

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
        async function saveAdmins() {
            try {
                const res = await fetch('/api/bot/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type: 'admins', payload: currentDbAdmins })
                });
                
                if (res.ok) {
                    location.reload();
                } else {
                    showToast('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤', 'error');
                }
            } catch (error) {
                console.error(error);
                showToast('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error');
            }
        }
    </script>
</AdminLayout>
